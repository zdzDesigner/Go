<!doctype html>
<html>
  <head> </head>
  <body>
    <video id="video" muted="muted" width="80"></video>
    <script>
      const video = document.getElementById("video")
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      })

      console.log({ pc })
      pc.ontrack = (evt) => {
        console.log("track", evt)
        const stream = evt.streams[0]
        console.log(stream.getTracks())
        video.srcObject = stream
        // video.play()
      }

      pc.onicecandidate = (evt) => {
        console.log({ evt })
        if (evt.candidate) {
          ws.send(
            JSON.stringify({
              type: "candidate",
              candidate: evt.candidate.candidate,
              sdpMid: evt.candidate.sdpMid,
              sdpMLineIndex: evt.candidate.sdpMLineIndex,
            }),
          )
        }
      }

      const ws = new WebSocket(`ws://${location.host}/ws`)
      ws.onmessage = async (evt) => {
        const msg = JSON.parse(evt.data)
        console.log({ msg })
        if (msg.type === "answer") {
          await pc.setRemoteDescription(msg)
        } else if (msg.candidate) {
          await pc.addIceCandidate(msg)
        }
      }

      ws.onopen = () => {
        // pc.addTransceiver("video").receiver.track
        pc.addTransceiver("video", { direction: "recvonly" })
        pc.createOffer()
          .then((offer) => pc.setLocalDescription(offer))
          .then(() => ws.send(JSON.stringify(pc.localDescription)))
      }
    </script>
  </body>
</html>
